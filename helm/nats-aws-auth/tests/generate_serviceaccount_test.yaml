suite: test generate serviceaccount
templates:
  - generate-serviceaccount.yaml
tests:
  - it: should not create when generate is disabled
    asserts:
      - hasDocuments:
          count: 0

  - it: should create a ServiceAccount when generate is enabled
    set:
      generate:
        enabled: true
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        serviceAccount:
          name: ""
          annotations: {}
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-nats-aws-auth-generate

  - it: should have hook annotations with correct weight
    set:
      generate:
        enabled: true
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        serviceAccount:
          name: ""
          annotations: {}
    asserts:
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: pre-install,pre-upgrade
      - equal:
          path: metadata.annotations["helm.sh/hook-weight"]
          value: "-5"
      - equal:
          path: metadata.annotations["helm.sh/hook-delete-policy"]
          value: "before-hook-creation,hook-succeeded"

  - it: should merge IRSA annotations with hook annotations
    set:
      generate:
        enabled: true
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        serviceAccount:
          name: ""
          annotations:
            eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/generate-role"
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789012:role/generate-role"
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: pre-install,pre-upgrade

  - it: should use custom service account name when specified
    set:
      generate:
        enabled: true
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        serviceAccount:
          name: "custom-generate-sa"
          annotations: {}
    asserts:
      - equal:
          path: metadata.name
          value: custom-generate-sa

  - it: should include common labels
    set:
      generate:
        enabled: true
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        serviceAccount:
          name: ""
          annotations: {}
    asserts:
      - matchRegex:
          path: metadata.labels["helm.sh/chart"]
          pattern: ^nats-aws-auth-
