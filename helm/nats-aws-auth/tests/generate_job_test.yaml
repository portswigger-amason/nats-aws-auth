suite: test generate job
templates:
  - generate-job.yaml
tests:
  - it: should not create when generate is disabled
    asserts:
      - hasDocuments:
          count: 0

  - it: should create a Job when generate is enabled
    set:
      generate:
        enabled: true
        configMapName: "nats-server-config"
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        ttlSecondsAfterFinished: 300
        backoffLimit: 3
        activeDeadlineSeconds: 300
        kubectlImage:
          repository: bitnami/kubectl
          tag: "1.31"
          pullPolicy: IfNotPresent
        resources:
          generate:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 256Mi
          kubectl:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 128Mi
        serviceAccount:
          name: ""
          annotations: {}
    asserts:
      - isKind:
          of: Job
      - equal:
          path: metadata.name
          value: RELEASE-NAME-nats-aws-auth-generate

  - it: should have hook annotations
    set:
      generate:
        enabled: true
        configMapName: "nats-server-config"
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        ttlSecondsAfterFinished: 300
        backoffLimit: 3
        activeDeadlineSeconds: 300
        kubectlImage:
          repository: bitnami/kubectl
          tag: "1.31"
          pullPolicy: IfNotPresent
        resources:
          generate:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 256Mi
          kubectl:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 128Mi
        serviceAccount:
          name: ""
          annotations: {}
    asserts:
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: pre-install,pre-upgrade
      - equal:
          path: metadata.annotations["helm.sh/hook-weight"]
          value: "0"
      - equal:
          path: metadata.annotations["helm.sh/hook-delete-policy"]
          value: "before-hook-creation,hook-succeeded"

  - it: should configure init container with correct CLI args
    set:
      generate:
        enabled: true
        configMapName: "nats-server-config"
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        ttlSecondsAfterFinished: 300
        backoffLimit: 3
        activeDeadlineSeconds: 300
        kubectlImage:
          repository: bitnami/kubectl
          tag: "1.31"
          pullPolicy: IfNotPresent
        resources:
          generate:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 256Mi
          kubectl:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 128Mi
        serviceAccount:
          name: ""
          annotations: {}
      kms:
        aliasPrefix: "test-prefix"
      accounts:
        operator: "Test-Operator"
        sys: "TEST-SYS"
        auth: "TEST-AUTH"
        app: "TEST-APP"
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: generate
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--generate"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--output"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "/output"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--alias-prefix"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "test-prefix"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--operator-name"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "Test-Operator"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--sys-account"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "TEST-SYS"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--auth-account-name"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "TEST-AUTH"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--app-account-name"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "TEST-APP"

  - it: should include region flag when kms.region is set
    set:
      generate:
        enabled: true
        configMapName: "nats-server-config"
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        ttlSecondsAfterFinished: 300
        backoffLimit: 3
        activeDeadlineSeconds: 300
        kubectlImage:
          repository: bitnami/kubectl
          tag: "1.31"
          pullPolicy: IfNotPresent
        resources:
          generate:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 256Mi
          kubectl:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 128Mi
        serviceAccount:
          name: ""
          annotations: {}
      kms:
        aliasPrefix: "nats"
        region: "us-east-1"
    asserts:
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--region"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "us-east-1"

  - it: should not include region flag when kms.region is not set
    set:
      generate:
        enabled: true
        configMapName: "nats-server-config"
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        ttlSecondsAfterFinished: 300
        backoffLimit: 3
        activeDeadlineSeconds: 300
        kubectlImage:
          repository: bitnami/kubectl
          tag: "1.31"
          pullPolicy: IfNotPresent
        resources:
          generate:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 256Mi
          kubectl:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 128Mi
        serviceAccount:
          name: ""
          annotations: {}
    asserts:
      - notContains:
          path: spec.template.spec.initContainers[0].args
          content: "--region"

  - it: should configure kubectl container correctly
    set:
      generate:
        enabled: true
        configMapName: "my-config"
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        ttlSecondsAfterFinished: 300
        backoffLimit: 3
        activeDeadlineSeconds: 300
        kubectlImage:
          repository: bitnami/kubectl
          tag: "1.31"
          pullPolicy: IfNotPresent
        resources:
          generate:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 256Mi
          kubectl:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 128Mi
        serviceAccount:
          name: ""
          annotations: {}
    asserts:
      - equal:
          path: spec.template.spec.containers[0].name
          value: create-configmap
      - equal:
          path: spec.template.spec.containers[0].image
          value: "bitnami/kubectl:1.31"
      - matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: kubectl create configmap my-config

  - it: should set security contexts correctly
    set:
      generate:
        enabled: true
        configMapName: "nats-server-config"
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        ttlSecondsAfterFinished: 300
        backoffLimit: 3
        activeDeadlineSeconds: 300
        kubectlImage:
          repository: bitnami/kubectl
          tag: "1.31"
          pullPolicy: IfNotPresent
        resources:
          generate:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 256Mi
          kubectl:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 128Mi
        serviceAccount:
          name: ""
          annotations: {}
    asserts:
      # Pod security context
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 65532
      # Init container security context
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.readOnlyRootFilesystem
          value: true
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.capabilities.drop[0]
          value: ALL
      # Main container security context
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop[0]
          value: ALL

  - it: should configure volume mounts correctly
    set:
      generate:
        enabled: true
        configMapName: "nats-server-config"
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        ttlSecondsAfterFinished: 300
        backoffLimit: 3
        activeDeadlineSeconds: 300
        kubectlImage:
          repository: bitnami/kubectl
          tag: "1.31"
          pullPolicy: IfNotPresent
        resources:
          generate:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 256Mi
          kubectl:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 128Mi
        serviceAccount:
          name: ""
          annotations: {}
    asserts:
      # Init container mounts output volume
      - contains:
          path: spec.template.spec.initContainers[0].volumeMounts
          content:
            name: output
            mountPath: /output
      # Main container mounts output read-only and tmp
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: output
            mountPath: /output
            readOnly: true
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: tmp
            mountPath: /tmp
      # Volumes exist
      - contains:
          path: spec.template.spec.volumes
          content:
            name: output
            emptyDir: {}
      - contains:
          path: spec.template.spec.volumes
          content:
            name: tmp
            emptyDir: {}

  - it: should configure backoff and deadline settings
    set:
      generate:
        enabled: true
        configMapName: "nats-server-config"
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        ttlSecondsAfterFinished: 600
        backoffLimit: 5
        activeDeadlineSeconds: 600
        kubectlImage:
          repository: bitnami/kubectl
          tag: "1.31"
          pullPolicy: IfNotPresent
        resources:
          generate:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 256Mi
          kubectl:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 128Mi
        serviceAccount:
          name: ""
          annotations: {}
    asserts:
      - equal:
          path: spec.backoffLimit
          value: 5
      - equal:
          path: spec.activeDeadlineSeconds
          value: 600
      - equal:
          path: spec.ttlSecondsAfterFinished
          value: 600

  - it: should use OnFailure restart policy
    set:
      generate:
        enabled: true
        configMapName: "nats-server-config"
        hookDeletePolicy: "before-hook-creation,hook-succeeded"
        ttlSecondsAfterFinished: 300
        backoffLimit: 3
        activeDeadlineSeconds: 300
        kubectlImage:
          repository: bitnami/kubectl
          tag: "1.31"
          pullPolicy: IfNotPresent
        resources:
          generate:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 256Mi
          kubectl:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 128Mi
        serviceAccount:
          name: ""
          annotations: {}
    asserts:
      - equal:
          path: spec.template.spec.restartPolicy
          value: OnFailure
